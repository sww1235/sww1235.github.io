<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="author" content="Stephen Walker-Weinshenker">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="styles/main.css">
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
<title>build-script-notes-main-ws-host</title>
</head>
<body>
<div id="top">
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</div>
<div id="topnavbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</div>
<h1 id="top">
Main Workstation Build Script and Notes
</h1>
<p>This is the build script for my main workstation PC and associated VMs.</p>
<h2 id="notes">
Notes
</h2>
<p>VM specific buildscripts are in their own files and are linked at the bottom of the page</p>
<h2 id="build-script">
Build Script
</h2>
<h3 id="initial-configuration">
Initial Configuration
</h3>
<ol type="1">
<li><p>Download the void-live-musl_x86-64 .iso of void linux from reputable sources, currently <a href="https://alpha.de.repo.voidlinux.org/live/current/">here</a></p></li>
<li><p>Burn image to USB thumbdrive using either <code>dd</code> or whatever windows tool is the popular thing and preferably doesnâ€™t use electron.</p></li>
<li><p>Login as root with default password of <code>void-linux</code> to live image.</p></li>
<li><p>Make sure you are booted using UEFI by validating presence of <code>/sys/firmware/efi</code> directory</p></li>
<li><p>run <code>void-installer</code></p></li>
<li><p>Proceed through installation wizard</p>
<ol type="1">
<li>Keyboard=us</li>
<li>Either interface is fine, along with DHCP. This will get changed when we set up the VMs</li>
<li>Source=network</li>
<li>Hostname=main-ws-host</li>
<li>Timezone=America/Denver or appropriate</li>
<li>Root password from password manager - generated</li>
<li>User account from password manager</li>
<li>Select grub to autoinstall GRUB2 bootloader. TODO: change to rEFInd instead</li>
<li>Partition main SSD using GPT scheme</li>
<li>Set filesystems</li>
<li>Review settings</li>
<li>Install</li>
<li>Wait</li>
<li>Reboot</li>
</ol></li>
<li><p>Log in as the new user you created</p></li>
<li><p>Static IP address setup. Add the following to <code>/etc/dhcpcd.conf</code> and restart dhcpcd service <code>sudo sv restart dhcpcd</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb1-1" title="1"><span class="dt">interface eno1</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="dt">inform ip_address</span><span class="ot">=</span><span class="st">$ipaddress</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="dt">static ip_address</span><span class="ot">=</span><span class="st">$ipaddress/subnet</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="dt">static routers</span><span class="ot">=</span><span class="st">$gateway</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="dt">static domain_name_servers</span><span class="ot">=</span><span class="st">$gateway</span></a></code></pre></div></li>
<li><p>Update the system by running the following command until there is no output.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">sudo</span> xbps-install -Svu</a></code></pre></div></li>
<li><p>Install the following packages. The st-terminfo install fixes <code>st-256color unknown terminal type</code> issues as well as backspace and tab issues when sshing in from other computers using the <code>st</code> terminal emulator.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">sudo</span> xbps-install nano thefuck vim st-terminfo</a></code></pre></div></li>
<li><p>Setup system logging using socklog</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">sudo</span> xbps-install socklog-void</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co"># enable services</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="fu">sudo</span> ln -s /etc/sv/socklog-unix/ /var/service</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="fu">sudo</span> ln -s /etc/sv/nanoklogd/ /var/service</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co"># add user to log group</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="fu">sudo</span> usermod -a -G socklog <span class="va">$USER</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co"># log out and log back in</span></a></code></pre></div></li>
<li><p>Set up ssh-agent using user specific services. Instructions taken from <a href="https://www.daveeddy.com/2018/09/15/using-void-linux-as-my-daily-driver/" class="uri">https://www.daveeddy.com/2018/09/15/using-void-linux-as-my-daily-driver/</a></p>
<ol type="1">
<li>Create user specific service directory:</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="fu">sudo</span> mkdir /etc/sv/runit-user-toxicsauce</a></code></pre></div>
<ol start="2" type="1">
<li>Create run script for user specific service by adding the following into <code>/etc/sv/runit-user-toxicsauce/run</code></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="co">#!/bin/sh</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="bu">exec</span> <span class="op">2&gt;&amp;1</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="bu">exec</span> chpst -u toxicsauce:toxicsauce runsvdir /home/toxicsauce/runit/service</a></code></pre></div>
<ol start="3" type="1">
<li>Mark it as executable:</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">sudo</span> chmod +x /etc/sv/runit-user-toxicsauce/run</a></code></pre></div>
<ol start="4" type="1">
<li>Create necessary user specific service directories:</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">mkdir</span> ~/runit</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="fu">mkdir</span> ~/runit/sv</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="fu">mkdir</span> ~/runit/service</a></code></pre></div>
<ol start="5" type="1">
<li>Start this service of services with:</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">sudo</span> ln -s /etc/sv/runit-user-toxicsauce /var/service</a></code></pre></div>
<ol start="6" type="1">
<li>Now set up <code>ssh-agent</code> service:</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1"><span class="fu">mkdir</span> ~/runit/sv/ssh-agent</a></code></pre></div>
<ol start="7" type="1">
<li>Create run script for <code>ssh-agent</code> service by adding the following into <code>~/runit/sv/ssh-agent/run</code>.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1"><span class="co">#!/usr/bin/env bash</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">#</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co"># Start ssh-agent from runit</span></a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="va">file=</span>~/.ssh/ssh-agent-env</a>
<a class="sourceLine" id="cb11-6" title="6"></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="bu">exec</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">$file</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb11-8" title="8"></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="bu">echo</span> <span class="st">&quot;# started </span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb11-10" title="10"></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co"># For some reason, this line doesn&#39;t get emitted by ssh-agent when it is run</span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co"># with -d or -D.  Since we are starting the program with exec we already know</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co"># the pid ahead of time though so we can create this line manually</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="bu">echo</span> <span class="st">&quot;SSH_AGENT_PID=</span><span class="va">$$</span><span class="st">; export SSH_AGENT_PID&quot;</span></a>
<a class="sourceLine" id="cb11-15" title="15"></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="bu">exec</span> ssh-agent -D</a></code></pre></div>
<ol start="8" type="1">
<li>Mark run file as executable with:</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="fu">chmod</span> +x ~/runit/sv/ssh-agent/run</a></code></pre></div>
<ol start="9" type="1">
<li>Now start the service with:</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" title="1"><span class="fu">ln</span> -s ~/runit/sv/ssh-agent ~/runit/service</a></code></pre></div>
<p><strong>NOTE</strong>: you need the following line in bashrc in order to get it working in new shells. This is already in my dotfiles bashrc</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1"><span class="co"># source ssh-agent file</span></a>
<a class="sourceLine" id="cb14-2" title="2"></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="bu">[</span> <span class="ot">-f</span> <span class="va">$HOME</span>/.ssh/ssh-agent-env<span class="bu"> ]</span> <span class="kw">&amp;&amp;</span> <span class="bu">source</span> <span class="va">$HOME</span>/.ssh/ssh-agent-env</a></code></pre></div></li>
</ol>
<p>TODO: add in instructions around btrfs and mounting separate file systems</p>
<ol start="13" type="1">
<li><p>Create Projects directory tree in <code>~</code> as follows:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1"><span class="fu">mkdir</span> -p ~/projects/src/github.com/sww1235</a></code></pre></div>
<p>This mirrors the structure of how golang wants to set things up.</p></li>
<li><p>Make symlink in <code>~</code> as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1"><span class="fu">ln</span> -s ~/projects/src/github.com/sww1235 myprojects</a></code></pre></div></li>
<li><p>Clone dotfiles repo from GitHub using ssh and install vim and bash files using <code>install.sh</code> script.</p></li>
<li><p>Clone projects from github into Projects tree as desired.</p></li>
<li><p>Set up void-packages per the <a href="void-packages-setup.html">instructions</a> in this wiki.</p></li>
</ol>
<h3 id="vfio-kvm-qemu-config">
VFIO/KVM/QEMU Configuration
</h3>
<ol type="1">
<li><p>install qemu and socat</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" title="1"><span class="fu">sudo</span> xbps-install qemu socat</a></code></pre></div></li>
<li><p>Create QEMU directory</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" title="1"><span class="fu">sudo</span> mkdir /etc/qemu</a></code></pre></div></li>
<li><p>download ovmf. It is not in xbps so need to manually download from <a href="https://www.kraxel.org/repos/jenkins/edk2/" class="uri">https://www.kraxel.org/repos/jenkins/edk2/</a> as of the writing of this build. Download the ovmf appropriate either 32 or 64 bit version. This will be in RPM format, so need to:</p></li>
<li><p>Install rpmextract.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" title="1"><span class="fu">sudo</span> xbps-install rpmextract</a></code></pre></div></li>
<li><p>Then run either:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" title="1"><span class="ex">rpm2cpio</span> <span class="op">&lt;</span>file<span class="op">&gt;</span>.rpm <span class="kw">|</span> <span class="fu">xz</span> -d <span class="kw">|</span> <span class="fu">cpio</span> -idmv</a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" title="1"><span class="ex">rpm2cpio</span> <span class="op">&lt;</span>file<span class="op">&gt;</span>.rpm <span class="kw">|</span> <span class="fu">lzma</span> -d <span class="kw">|</span> <span class="fu">cpio</span> -idmv</a></code></pre></div>
<p>to extract the files needed.</p></li>
<li><p>Copy the files inside the <code>./usr/share/edk2.git/ovmf-x64</code> directory inside the extracted files, to <code>/usr/share/ovmf/</code>. This path is hardcoded in the <code>vm-manager.sh</code> script and will need to be changed if ovmf is installed in another location.</p>
<p>smm varients include secure boot code, csm varients include legacy compat modules. code and vars are separate files that are both contained in OVMF base.</p></li>
<li><p>Create kvm:kvm user/group as system group</p></li>
<li><p>Clone vm-manager repo into projects directory, and symlink to good location for executable scripts in path</p></li>
<li><p>since we are running as -user kvm, need to edit <code>/etc/security/limits.conf</code> and increase them for user kvm, as well as root and main user. This allows us to grant large amounts of memory to the guest.</p>
<p>Add the following lines to the file.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb22-1" title="1"><span class="dt">@kvm        soft    memlock unlimited</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="dt">@kvm        hard    memlock unlimited</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="dt">toxicsauce  soft    memlock unlimited</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="dt">toxicsauce  hard    memlock unlimited</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="dt">root        soft    memlock unlimited</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="dt">root        hard    memlock unlimited</span></a></code></pre></div>
<p>From: <a href="https://stackoverflow.com/questions/39187619/vfio-dma-map-error-when-passthrough-gpu-using-libvirt" class="uri">https://stackoverflow.com/questions/39187619/vfio-dma-map-error-when-passthrough-gpu-using-libvirt</a></p></li>
<li><p>Set up kernel drivers for PCIe passthrough.</p>
<ol type="1">
<li><p>Create file <code>blacklist.conf</code> in `/etc/modprobe.d/ and add the following to the contents. This prevents the nouveau driver from loading and taking over the nvidia card before the vfio-pci driver can load.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb23-1" title="1"><span class="ex">blacklist</span> nouveau</a></code></pre></div></li>
<li><p>Create file <code>vfio.conf</code> in <code>/etc/modprobe.d/ and then set contents to the following, changing pcie ids as needed to those found via</code>lspci`</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb24-1" title="1"><span class="co"># 10de:1c03</span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="co"># 10de:10f1</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="co"># 1912:0014 - usb3 pcie card</span></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co"># 8086:15b8 - 219V ethernet card</span></a>
<a class="sourceLine" id="cb24-5" title="5"><span class="co"># 8086:1539 - I211 ethernet card</span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="ex">options</span> vfio-pci ids=10de:1c03,10de:10f1,1912:0014,8086:1539</a>
<a class="sourceLine" id="cb24-7" title="7"></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co"># load vfio-pci before xhci-hcd and igb else the usb3 pcie card</span></a>
<a class="sourceLine" id="cb24-9" title="9"><span class="co"># and intel nic are claimed by xhci_hcd</span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="ex">softdep</span> xhci_hcd pre: vfio_pci</a>
<a class="sourceLine" id="cb24-11" title="11"><span class="ex">softdep</span> igb pre: vfio_pci</a></code></pre></div>
<p>This tells <code>vfio-pci</code> to attach to the specified PCIe devices. It also creates a soft dependancy of <code>vfio-pci</code> on <code>xhci_hcd</code> so <code>vfio-pci</code> will in theory load before <code>xhci_hcd</code> and attach to the usb controller before <code>xhci_hcd</code> does.</p></li>
<li><p>Create file <code>vfio.conf</code> in /etc/modules-load.d` with the contents:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb25-1" title="1"><span class="ex">vfio</span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="ex">vfio-pci</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="ex">vfio-virqfd</span></a></code></pre></div>
<p>This loads the specified kernel drivers for VFIO use.</p></li>
<li><p>Create file <code>dracut.conf</code> in <code>/etc/dracut.conf.d/</code> with the contents:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb26-1" title="1"><span class="va">add_drivers+=</span><span class="st">&quot; vfio vfio-pci vfio_iommu_type1 vfio_virqfd &quot;</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="va">add_dracutmodules+=</span><span class="st">&quot; kernel-modules &quot;</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="va">omit_drivers+=</span><span class="st">&quot; nouveau &quot;</span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="va">hostonly=</span>yes</a></code></pre></div>
<p>This adds the correct drivers into the initramfs and prevents the nouveau driver from being loaded.</p></li>
<li><p>Now run regenerate initramfs and DKMS modules with:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb27-1" title="1"><span class="fu">sudo</span> xbps-reconfigure --force <span class="va">$linux</span>-kernel-package</a></code></pre></div></li>
<li><p>Reboot</p></li>
</ol></li>
<li><p>Check lscpi -v to make sure that <code>vfio-pci</code> has correctly bound to the graphics card, usb card and nic.</p></li>
<li><p>start VM to test using script in vm-manager repo.</p></li>
</ol>
<h3 id="extra-host-config">
Extra Host Configuration
</h3>
<ol type="1">
<li><p>Install network-ups-tools.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb28-1" title="1"><span class="fu">sudo</span> xbps-install network-ups-tools</a></code></pre></div></li>
<li><p>Edit <code>/etc/ups/upsmon.conf</code> and add the following lines:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb29-1" title="1"><span class="dt">MONITOR cyberpower@$rackmonitorIP 1 upsmonSlave $password slave</span></a></code></pre></div></li>
<li><p>Start <code>upsmon</code> service <code>ln -s /etc/sv/upsmon/ /var/service</code></p></li>
</ol>
<h3 id="vm-specifics">
VM Specific Setup
</h3>
<ul>
<li><a href="build-script-notes-void-vm.html">Void VM</a></li>
<li><a href="build-script-notes-win10-vm.html">Win10 VM</a></li>
</ul>
<h2 id="resources">
Resources
</h2>
<p><a href="https://www.reddit.com/r/voidlinux/comments/ghwvv5/guide_how_to_setup_qemukvm_emulation_on_void_linux/" class="uri">https://www.reddit.com/r/voidlinux/comments/ghwvv5/guide_how_to_setup_qemukvm_emulation_on_void_linux/</a></p>
<pre class="tags"><code>build-script, main-ws-host, workstation, notes, QEMU, KVM, VFIO, Passthrough</code></pre>
</body>
</html>
