<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="author" content="Stephen Walker-Weinshenker">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="styles/main.css">
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
<title>build-script-notes-vault-mki</title>
</head>
<body>
<div id="top">
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</div>
<div id="topnavbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</div>
<h1 id="top">
Vault File Server Build Script
</h1>
<p>This is the build script for my main file server <strong>The Vault</strong>.</p>
<h2 id="notes">
Notes
</h2>
<p>F2 or Enter for BIOS, F11 for boot menu</p>
<h2 id="build-script">
Build Script
</h2>
<h3 id="prereqs&quot;">
Prerequisites
</h3>
<ol style="list-style-type: decimal">
<li><p>Connect to IPMI interface of the server by going to $ip in a web browser.</p>
<ul>
<li>If this is first startup of system, then configure static IP for IPMI, and admin user and password.</li>
</ul></li>
</ol>
<h3 id="initial-configuration">
Initial Configuration
</h3>
<ol style="list-style-type: decimal">
<li><p>Download the bootonly ISO of the current release of FreeBSD from reputable sources. (12.2 as of 11/07/2020)</p></li>
<li><p>Enable cd/dvd instance in IPMI under Settings -&gt; Media Redirection Settings -&gt; VMedia Instance Settings</p></li>
<li><p>Open up HTML5 viewer for IPMI, and attach ISO to virtual CD rom.</p></li>
<li><p>Start server, and boot to UEFI CD rom.</p></li>
<li><p>Let FreeBSD boot to the install menu. Don't exit out of the autoboot menu.</p></li>
<li><p>Press enter to start the instllation process.</p></li>
<li><p>Proceed through installation wizard. Press space to select options.</p>
<ol style="list-style-type: decimal">
<li><p>Keymap = United States of America. Space will not work here, just scroll down and hit enter.</p></li>
<li><p>Hostname = <code>the-vault</code></p></li>
<li><p>Disable kernel-dbg system component, and add the ports tree.</p></li>
<li><p>Hit Ok to configure network for installation.</p></li>
<li><p>Select gigabit interface 0, or whatever is actually connected.</p></li>
<li><p>Configure IPv4 and use DHCP for now. We will configure static networking later.</p></li>
<li><p>Confirm resolver config. (Defaults picked up from DHCP should be good to go.)</p></li>
<li><p>Select mirror</p></li>
<li><p>Select Auto (UFS) and then Entire Disk.</p></li>
<li><p>Select GPT for partition scheme</p></li>
<li><p>Review autogen partition layout, which should be good for our usages then hit finish and Commit.</p></li>
<li><p>Wait for download, verification and extraction.</p></li>
<li><p>Enter root password from password manager.</p></li>
<li><p>Choose no at CMOS clock prompt. TODO: fix this.</p></li>
<li><p>Choose timezone.</p></li>
<li><p>Skip time and date setup if it is correct.</p></li>
<li><p>Enable <code>local_unbound</code>, <code>sshd</code>, <code>ntpd</code>, <code>powerd</code> and <code>dumpdev</code> services to be started at boot</p></li>
<li><p>Enable all security options except <code>disable_syslogd</code> , <code>secure_console</code> and <code>disable_sendmail</code>. Sendmail will be replaced later.</p></li>
<li><p>Add new admin user.</p>
<ol style="list-style-type: decimal">
<li>Username = <code>toxicsauce</code></li>
<li>Full Name = <code>toxicsauce</code></li>
<li>UID = (hit enter to accept default)</li>
<li>Login group = (hit enter to accept default)</li>
<li>Invite User to other groups = wheel</li>
<li>Login class = (hit enter to accept default)</li>
<li>Shell = sh (default)</li>
<li>home directory = (hit enter to accept default)</li>
<li>home directory permissions = (hit enter to accept defaults)</li>
<li>password auth = yes</li>
<li>empty password = no</li>
<li>random password = no</li>
<li>Enter password from password manager</li>
<li>lock account = no</li>
<li>check options and type in yes to confirm.</li>
<li>add additional users = no.</li>
</ol></li>
<li><p>hit exit, and no to exit installer.</p></li>
<li><p>Hit reboot.</p></li>
<li><p>Stop CD media after system has rebooted.</p></li>
</ol></li>
<li><p>Log in as the new user you created</p></li>
<li><p>Become root with <code>su -</code>. You will need root's password.</p></li>
<li><p>Change root's shell to <code>sh</code>: <code>chsh -s sh</code></p></li>
<li><p>Log out and su back in again</p></li>
<li><p>Update system and install software</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="ex">freebsd-update</span> fetch
<span class="ex">freebsd-update</span> install

<span class="ex">pkg</span> update
<span class="co"># answer yes to install pkg system</span>
<span class="ex">pkg</span> upgrade

<span class="ex">pkg</span> install nano sudo ipmitool openipmi</code></pre></div></li>
<li><p>Configure sudo. <code>visudo</code> and uncomment line <code>%wheel ALL=(ALL) ALL</code></p></li>
<li><p>Configure static IP addressing. First, run <code>ifconfig</code> to see what interface is actually connected, then add the following lines to <code>/etc/rc.conf</code> and modify existing lines so they read as follows.</p>
<pre class="conf"><code>ifconfig_igb0=&quot;inet $ipaddress netmask $netmask&quot;
defaultrouter=&quot;$gateway&quot;</code></pre>
<p>Also, add the following line to <code>/etc/resolv.conf</code></p>
<pre class="conf"><code>nameserver $gateway</code></pre></li>
<li><p>Setup system logging</p></li>
<li><p>Set up ssh-agent</p></li>
<li><p>Create Projects directory tree in <code>~</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ~/projects/src/github.com/sww1235</code></pre></div>
<p>This mirrors the structure of how golang wants to set things up.</p></li>
<li><p>Make symlink in <code>~</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ln</span> -s ~/projects/src/github.com/sww1235 myprojects</code></pre></div></li>
<li><p>Clone dotfiles repo from GitHub using ssh and install vim and bash files using <code>install.sh</code> script.</p></li>
<li><p>Clone projects from github into Projects tree as desired.</p></li>
</ol>
<h3 id="ups-config">
UPS Configuration
</h3>
<ol style="list-style-type: decimal">
<li><p>Install Network UPS Tools from packages. <code>sudo pkg install nut</code></p></li>
<li><p>Edit <code>/usr/local/etc/nut/upsmon.conf</code> and add in the following lines:</p>
<pre class="conf"><code>MONITOR cyberpower@$ipaddress 1 upsmonSlave $password slave</code></pre></li>
<li><p>Edit <code>/etc/rc.conf</code> and add the following line:</p>
<pre class="conf"><code>nut_upsmon_enable=&quot;YES&quot;</code></pre></li>
<li><p>Start <code>nut_upsmon</code> service with <code>sudo service nut_upsmon start</code> and make sure it doesn't error out.</p></li>
<li><p>Reboot system to make sure everything comes up normally.</p></li>
<li><p>Run a shutdown test to make sure nut is working properly.</p>
<ol style="list-style-type: decimal">
<li><p>Login to <code>rack-monitor</code> system and run <code>upsdrvctl -t shutdown</code>. This will show you what will happen during a shutdown without actually shutting the systems down.</p></li>
<li><p>Now run the command <code>upsmon -c fsd</code>. This will simulate a power failure and send the shutdown signal to all connected machines before shutting down itself.</p></li>
<li><p>This should have worked, so now you need to manually remove power and apply power from all machines connected to the UPS to get them to come back up.</p></li>
</ol></li>
</ol>
<h3 id="zfs-config">
ZFS Configuration
</h3>
<p>Also see the <a href="https://www.freebsd.org/doc/handbook/zfs.html">ZFS chapter of the FreeBSD handbook</a></p>
<p>The current vdev design is 6 identical disks running in a RAIDZ2 configuration. When the storage is expanded, a new group of 6 disks will be added to a new vdev and added to the zpool.</p>
<p>vdev = group of drives. You cannot add more drives to a vdev once it is created.</p>
<p>zpool = group of vdevs. Redundancy is given by vdev configuration, not by multiple vdevs. if 1 vdev fails completely, <strong>all</strong> data in zpool is lost.</p>
<ol style="list-style-type: decimal">
<li><p>Install smartmontools and e2fsprogs packages.</p></li>
<li><p>If the hard drives are new, Test hard drives with <code>sudo badblocks -b 4096 -wsv /dev/da* &gt; da*.log</code>, replacing * with the number for each HDD. This will take a while depending on the size of the hard drives.</p></li>
<li><p>Add the following line to <code>/etc/rc.conf</code>, then start the service manually <code>sudo service zfs start</code> so you don't have to reboot.</p>
<pre class="conf"><code>zfs_enable=&quot;YES&quot;</code></pre></li>
<li><p>Add the following lines to <code>/boot/loader.conf</code> if they are not already there and reboot. This enables unique and static labels per disk, similar to <code>/dev/disk/by-id/</code> on linux.</p>
<pre class="conf"><code>geom_label_load=&quot;YES&quot;
kern.geom.label.disk_ident.enable=&quot;1&quot;</code></pre></li>
<li><p>Now create and configure the zpool and vdevs as follows:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co"># replace /dev/diskid/... with the names of the disks you are using in the zpool</span>
<span class="fu">sudo</span> zpool create the-vault raidz2 /dev/diskid/...
<span class="co"># add any additional 6 disk sets</span>
<span class="fu">sudo</span> zpool add the-vault raidz2 /dev/diskid/...</code></pre></div></li>
<li><p>Now create ZFS datasets as follows:</p>
<pre class="tags"><code>sudo zfs create -o compress=lz4 the-vault/backups
sudo zfs create -o compress=lz4 the-vault/storage
sudo zfs create -o compress=lz4 the-vault/media</code></pre></li>
<li><p>Install zfsbackup-go either from packages/ports or github directly.</p></li>
</ol>
<h3 id="filesharing">
Fileshare Configuration
</h3>
<h2 id="resources">
Resources
</h2>
<ul>
<li><a href="https://people.freebsd.org/~thierry/nut_FreeBSD_HowTo.txt" class="uri">https://people.freebsd.org/~thierry/nut_FreeBSD_HowTo.txt</a></li>
</ul>
<pre class="tags"><code>build-script, main-ws-host, workstation, notes, QEMU, KVM, VFIO, Passthrough</code></pre>
</body>
</html>
