<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Lenovo Laptop Build Script</title>
</head>
<body>
<header>
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</header>
<nav>
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</nav>
<header id="title-block-header">
<h1 class="title">Lenovo Laptop Build Script</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#notes">Notes</a></li>
<li><a href="#build-script">Build Script</a>
<ul>
<li><a href="#initial-configuration">Initial Configuration</a>
<ul>
<li><a href="#windows-installation">Windows Installation</a></li>
<li><a href="#refind-installation">rEFInd Installation</a></li>
<li><a href="#void-linux-installation">Void Linux Installation</a></li>
<li><a href="#void-linux-config">Void Linux Configuration</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<p>This is the build script and notes for my Lenovo T490 laptop.</p>
<section id="notes" class="level1">
<h1>Notes</h1>
</section>
<section id="build-script" class="level1">
<h1>Build Script</h1>
<section id="initial-configuration" class="level2">
<h2>Initial Configuration</h2>
<p>Laptop will start from factory with preinstalled Windows 10 Pro + bloatware. Reimage then setup dual booting.</p>
<section id="windows-installation" class="level3">
<h3>Windows Installation</h3>
<ol type="1">
<li><p>Download a copy of Windows 10 Pro from Microsoft</p></li>
<li><p>Create bootable USB stick using instructions on Microsoft website.</p></li>
<li><p>Disable fast boot in preinstalled windows.</p></li>
</ol>
<pre><code>1.	Go to Settings -&gt; System -&gt; Power &amp; Sleep -&gt; Additional Power Settings
	-&gt; Choose What Power Buttons Do -&gt; Change settings that are currently
	unavailable

2.	Uncheck &quot;Turn on Fast Startup&quot;. This prevents skipping the BIOS screen.</code></pre>
<ol start="4" type="1">
<li><p>Verify BIOS is set to allow booting from USB sticks. Also verify that BIOS is only set to UEFI mode</p></li>
<li><p>Make sure laptop does not have an internet connection. This allows for the creation of a local user account without a Microsoft account.</p></li>
<li><p>Insert USB stick and boot. Hit enter to interrupt startup, then select USB stick as boot drive.</p></li>
<li><p>Start windows install process. Select Language, Time and Keyboard options then press next.</p></li>
<li><p>Click Install Now.</p></li>
<li><p>Accept Terms and Conditions</p></li>
<li><p>Select Custom: Install Windows Only.</p></li>
<li><p>Wipe out all existing partitions on the main SSD, then create the following:</p></li>
</ol>
<pre><code>-	A main 120GB partition for windows
-	A 500GB partition for passthrough between Windows and Linux OS installs.

Leave the remaining space unpartitioned. This will be partitioned during the
linux install.

These will both be NTFS. Windowe will create additional partitions at the
beginning of the partition list for recovery ETC.</code></pre>
<ol start="12" type="1">
<li><p>Select the 120GB partiton to install windows on.</p></li>
<li><p>Wait for several reboots</p></li>
<li><p>Select Customize Settings option on Express Settings Prompt.</p></li>
<li><p>Turn off all Privacy and tracking options</p></li>
<li><p>When prompted to create an account, click join a Domain and follow prompts to create a local account.</p></li>
<li><p>After setup is finished, uninstall all apps that can be uninstalled, and clean up the start menu.</p></li>
<li><p>Install Lenovo Vantage from Lenovo’s website and make sure BIOS and drivers are installed and up to date. (Especially important for Thunderbolt devices)</p></li>
</ol>
</section>
<section id="refind-installation" class="level3">
<h3>rEFInd Installation</h3>
<p>Install rEFInd boot manager. These steps are shamelessly reappropriated and modified from <a href="https://rodsbooks.com/refind/installing.html#windows" class="uri">https://rodsbooks.com/refind/installing.html#windows</a></p>
<ol type="1">
<li><p>Download rEFInd as a binary ZIP file from reputable sources, currently: <a href="https://rodsbooks.com/refind/getting.html" class="uri">https://rodsbooks.com/refind/getting.html</a></p></li>
<li><p>Unzip the file in a place you can find it. Usually Desktop or Downloads is best.</p></li>
<li><p>Open an Administrator Command Prompt.</p></li>
<li><p>Type <code>mountvol S: /S</code> in the Administrator Command Prompt window. This makes the ESP accessible as drive S: from that window. (You can use a drive identifier other than S: if you like.)</p></li>
<li><p>Use <code>CD</code> command to change into the main rEFInd package directory, so that the refind subdirectory is visible when you type dir.</p></li>
<li><p>Type <code>xcopy /E refind S:\EFI\refind\</code> to copy the refind directory tree to the ESP’s EFI directory. If you omit the trailing backslash from this command, xcopy will ask if you want to create the refind directory. Tell it to do so.</p></li>
<li><p>Type <code>S:</code> to change to the ESP. (This changes which drive is active in Command Prompt)</p></li>
<li><p>Type <code>cd EFI\refind</code> to change into the refind subdirectory.</p></li>
<li><p>Delete the <code>drivers_ia32</code>, <code>refind_ia32.efi</code>, <code>tools_ia32</code>, <code>drivers_aa64</code>, <code>refind_aa64.efi</code> and <code>tools_aa64</code> files and directories using the <code>DEL</code> command. Unnecessary drivers will slow the rEFInd start process.</p></li>
<li><p>Type <code>rename refind.conf-sample refind.conf</code> to rename rEFInd’s configuration file.</p></li>
<li><p>Type <code>bcdedit /set "{bootmgr}" path \EFI\refind\refind_x64.efi</code> to set rEFInd as the default EFI boot program. Note that “{bootmgr}” is entered as such, including both the quotes and braces ({}).</p></li>
<li><p>Type <code>bcdedit /set "{bootmgr}" description "rEFInd description"</code> to set a description (change rEFInd description as you see fit).</p></li>
</ol>
<p>Now, when the laptop is rebooted, rEFInd should present itself with an option to boot into windows 10.</p>
</section>
<section id="void-linux-installation" class="level3">
<h3>Void Linux Installation</h3>
<ol type="1">
<li><p>Download a copy of <code>void-live-x86_64-date.iso</code> from reputable sources, currently: <a href="https://alpha.de.repo.voidlinux.org/live/current/" class="uri">https://alpha.de.repo.voidlinux.org/live/current/</a>.</p></li>
<li><p>Create bootable USB stick using <code>dd</code> or whatever windows tool is the popular thing and preferably doesn’t use electron.</p></li>
<li><p>Login to live environment as <code>root</code> with password <code>voidlinux</code>.</p></li>
<li><p>Verify system is booted in UEFI mode by verifying the presence of the <code>/sys/firmware/efi/</code> directory.</p></li>
<li><p>run <code>void-installer</code> to start the installation wizard.</p></li>
<li><p>Specify the <code>us</code> keymap.</p></li>
<li><p>Select DHCP.</p></li>
<li><p>Select install from network.</p></li>
<li><p>Set hostname to <code>the-machine</code>.</p></li>
<li><p>Set Locale to <code>en_US.UTF-8</code>.</p></li>
<li><p>Set timezone to local timezone.</p></li>
<li><p>Set root password to the one stored in password database.</p></li>
<li><p>Set up normal user account based on password database.</p></li>
<li><p>Select <code>none</code> for bootloader since rEFInd was installed earlier.</p></li>
<li><p>Create an <code>Linux filesystem</code> partition out of the remaining space on disk and write the partition map to disk. Make note of the partition names and filesystems for the next step.</p></li>
<li><p>Proceed through all partitions and set mount points as follows:</p></li>
</ol>
<pre><code>-	Do not set mount points for the `Windows recovery partion`, or the
	`Microsoft reserved` partition.

-	Set the `EFI System` partition filesystem to `vfat` and the mount point
	to `/boot/efi`.

-	Set the 500GB `Microsoft basic data` partition to filesystem `ntfs` and
	mountpoint `/mnt/passthrough`.

-	Set the ~1.3TB `Linux filesystem` partition to filesystem `ext4` and
	mountpoint `/`.</code></pre>
<ol start="17" type="1">
<li><p>Review settings and install. This will take a while.</p></li>
<li><p>Reboot and select Void Linux at rEFInd prompt.</p></li>
</ol>
</section>
<section id="void-linux-config" class="level3">
<h3>Void Linux Configuration</h3>
<ol type="1">
<li><p>Login to newly installed Void Linux using root account and password found in password database. This is due to the fact that we haven’t configured sudo yet.</p></li>
<li><p>Configure <code>sudo</code> to allow full access to members of <code>wheel</code> group. Run <code>visudo</code> and uncomment the line</p></li>
</ol>
<pre><code>```sudo
#%wheel ALL=(ALL) ALL
```</code></pre>
<ol start="3" type="1">
<li>Enable NTP and DHCP services</li>
</ol>
<pre><code>```bash
ln -s /etc/sv/ntpd /var/service
ln -s /etc/sv/dhcpcd /var/service
```</code></pre>
<ol start="4" type="1">
<li><p>Create <code>passthrough</code> folder under <code>/mnt/</code> to allow passthrough partition to mount correctly.</p></li>
<li><p>Update system by running command <code>xbps-install -Svu</code> until it shows no updates.</p></li>
<li><p>Install ntfs driver.</p></li>
</ol>
<pre><code>```bash
xbps-install ntfs-3g
```</code></pre>
<ol start="7" type="1">
<li><p>Reboot system and login as normal user.</p></li>
<li><p>Enable trim on SSD by editing <code>/etc/fstab</code> and adding <code>,discard</code> after the defaults line on the <code>/</code> and <code>/mnt/passthrough</code> mountpoints.</p></li>
<li><p>Install and remove the following packages. Want to use simpler NTP implementation.</p></li>
</ol>
<pre><code>```bash
sudo xbps-install nano openntpd rng-tools thefuck vim htop socklog
sudo xbps-remove chrony
```</code></pre>
<ol start="10" type="1">
<li>Install commonly used applications.</li>
</ol>
<pre><code>```bash
sudo xbps-install firefox freecad git glow kicad lynx netcat p7zip powertop
rsync tmux unzip wget zip
```</code></pre>
<ol start="11" type="1">
<li>Setup system logging using socklog</li>
</ol>
<pre><code>```bash
sudo xbps-install socklog-void
# enable services
sudo ln -s /etc/sv/socklog-unix/ /var/service
sudo ln -s /etc/sv/nanoklogd/ /var/service
# add user to log group
sudo usermod -a -G socklog $USER
# log out and log back in
```</code></pre>
<ol start="12" type="1">
<li>Create projects directory tree in <code>~</code> as follows:</li>
</ol>
<pre><code>```bash
mkdir -p ~/projects/src/github.com/sww1235
```

This mirrors the structure of how golang wants to set things up.</code></pre>
<ol start="13" type="1">
<li><p>Clone dotfiles repo from GitHub and install vim and bash files using <code>install.sh</code> script.</p></li>
<li><p>Set up ssh-agent using user specific services. Instructions taken from <a href="https://www.daveeddy.com/2018/09/15/using-void-linux-as-my-daily-driver/" class="uri">https://www.daveeddy.com/2018/09/15/using-void-linux-as-my-daily-driver/</a></p></li>
</ol>
<pre><code>1.	Create user specific service directory:

	```bash
	sudo mkdir /etc/sv/runit-user-toxicsauce
	```

2.	Create run script for user specific service by adding the following
	into `/etc/sv/runit-user-toxicsauce/run`

	```bash
	#!/bin/sh
	exec 2&gt;&amp;1
	exec chpst -u toxicsauce:toxicsauce runsvdir /home/toxicsauce/runit/service
	```

3.	Mark it as executable:

	```bash
	sudo chmod +x /etc/sv/runit-user-toxicsauce/run
	```

4.	Create necessary user specific service directories:

	```bash
	mkdir ~/runit
	mkdir ~/runit/sv
	mkdir ~/runit/service
	```

5.	Start this service of services with:

	```bash
	sudo ln -s /etc/sv/runit-user-toxicsauce /var/service
	```

6.	Now set up `ssh-agent` service:

	```bash
	mkdir ~/runit/sv/ssh-agent
	```

7.	Create run script for `ssh-agent` service by adding the following into `~/runit/sv/ssh-agent/run`.

	```bash
	#!/usr/bin/env bash
	#
	# Start ssh-agent from runit

	file=~/.ssh/ssh-agent-env

	exec &gt; &quot;$file&quot;

	echo &quot;# started $(date)&quot;

	# For some reason, this line doesn&#39;t get emitted by ssh-agent when it is run
	# with -d or -D.  Since we are starting the program with exec we already know
	# the pid ahead of time though so we can create this line manually
	echo &quot;SSH_AGENT_PID=$$; export SSH_AGENT_PID&quot;

	exec ssh-agent -D
	```

8.	Mark run file as executable with:

	```bash
	chmod +x ~/runit/sv/ssh-agent/run
	```

9.	Now start the service with:

	```bash
	ln -s ~/runit/sv/ssh-agent ~/runit/service
	```</code></pre>
<ol start="15" type="1">
<li><p>Clone projects from github into Projects tree as desired.</p></li>
<li><p>Set up void-packages per the <a href="void-packages-setup.html">instructions</a> in this wiki.</p></li>
<li><p>Make sure <code>build-branch-the-machine</code> in my fork of <code>void-packages</code> is checked out, and up to date with desired patches. See the <a href="void-suckless-config.html">suckless page](void-s</a> for more info.</p></li>
<li><p>Build binary packages of <code>dwm</code>, <code>dmenu</code>, <code>st</code> and <code>slstatus</code> as follows:</p></li>
</ol>
<pre><code>```bash
cd ~/Projects/src/github.com/sww1235/void-packages
./xbps-src pkg dwm
./xbps-src pkg dmenu
./xbps-src pkg st
./xbps-src pkg slstatus
```</code></pre>
<ol start="19" type="1">
<li>Install <code>dwm</code>, <code>dmenu</code>, <code>st</code> and <code>slstatus</code> with the command:</li>
</ol>
<pre><code>```bash
sudo xbps-install --repository=hostdir/binpkgs/build-branch-the-machine \
	dwm dmenu st slstatus
```</code></pre>
<ol start="20" type="1">
<li>Modify ~/.xinitrc to contain the following:</li>
</ol>
<pre><code>```xinitrc
slstatus &amp;
exec dwm
```</code></pre>
<ol start="21" type="1">
<li>Install <code>tlp</code> for power management:</li>
</ol>
<pre><code>```bash
sudo xbps-install tlp
sudo ln -s /etc/sv/tlp /var/service
```</code></pre>
<ol start="22" type="1">
<li>Setup CUPS for printing:</li>
</ol>
<pre><code>1.	Install and enable the service:

	```bash
	sudo xbps-install cups
	sudo ln -s /etc/sv/cupsd/ /var/service
	```

2.	Edit /etc/cups/cupsd.conf, find line that starts with `&lt;Limit
	CUPS-Add-Modify-Printer` and add `toxicsauce` after `@SYSTEM`

3.	Restart `cupsd` service

4. go to &lt;http://localhost:631/&gt; to configure</code></pre>
<ol start="23" type="1">
<li>Need to set up bumblebee/optimus for graphics, set up dropbox and 1password cli client.</li>
</ol>
<pre><code>install alsa-utils to get audio working</code></pre>
<pre class="tags"><code>build-script, void-linux,laptop, lenovo, notes</code></pre>
</section>
</section>
</section>
<footer>
	<address>
	sww1235.net<br/>
	write to: website &lt;at-sign&gt; sww1235.net
	</address>

&copy; 2021 - Stephen Walker-Weinshenker

</footer>
</body>
</html>
