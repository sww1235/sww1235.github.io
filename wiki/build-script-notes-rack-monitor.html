<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="author" content="Stephen Walker-Weinshenker">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="styles/main.css">
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
<title>build-script-notes-rack-monitor</title>
</head>
<body>
<div id="top">
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</div>
<div id="topnavbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</div>
<h1 id="top">
Rack Monitor Build Script and Notes
</h1>
<p>This is the build script and notes for the raspberry pi that monitors my Rack and UPS.</p>
<h2 id="notes">
Notes
</h2>
<h2 id="build-script">
Build Script
</h2>
<h3 id="initial-configuration">
Initial Configuration
</h3>
<ol style="list-style-type: decimal">
<li><p>Download the rpi2-musl image of void linux from reputable sources, currently <a href="https://alpha.de.repo.voidlinux.org/live/current/">here</a></p></li>
<li><p>Burn image to MicroSD card using either <code>dd</code> or whatever windows tool is the popular thing and preferably doesn't use electron.</p></li>
<li><p>Use <code>cfdisk</code> to expand main partition from 2GB to remaining size of MicroSD card.</p></li>
<li><p>Login as root with default password of <code>void-linux</code></p></li>
<li><p>Need to get correct time and network set up in order to update system and install packages (as root) Remember that the only available text editor is <code>vi</code>!</p>
<ol style="list-style-type: decimal">
<li><p>Configure static IP address by editing <code>/etc/dhcpd.conf</code> with the following lines at the bottom of the file. Actual IP addresses are found in the network documentation. We use DHCP rather than manual <code>ip</code> commands in <code>/etc/rc.local</code> to take advantage of other aspects of DHCP including auto DNS server population and domain name.</p>
<p>also uncomment ntp_servers option</p>
<p>dns server is usually pfsense default gateway</p>
<pre class="conf"><code>interface eth0
inform ip_address=$IPaddress
static ip_address=$IPaddress
static routers=$defaultgateway
static domain_name_servers=$dnsserver</code></pre></li>
<li><p>edit <code>/etc/rc.conf</code> and change the following lines to set keymap and timezone:</p>
<pre class="conf"><code>TIMEZONE=&quot;America/Denver&quot; # or appropriate timezone
KEYMAP=&quot;us&quot;</code></pre></li>
<li><p>Enable NTP and DHCP services:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">ln</span> -s /etc/sv/ntpd /var/service
<span class="kw">ln</span> -s /etc/sv/dhcpcd /var/service</code></pre></div></li>
<li><p>Check <code>/etc/ntpd.conf</code> for constraints line, and comment out. This doesn't work on Raspi due to lack of HWCLK</p></li>
<li><p>Add <code>server $gateway</code> to <code>/etc/ntpd.conf</code> since it doesn't seem to pick it up from DHCP. NTP server will usually be the pfsense gateway, but use whatever machine is actually the NTP server</p></li>
<li><p>Create new non-root user, replacing $newusername with the actual name of the user. This command adds the user to the wheel group, which allows <code>sudo</code> access</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">useradd</span> -m -s /bin/bash -U -G wheel,users,audio,video,cdrom,input <span class="ot">$newusername</span></code></pre></div></li>
<li><p>Set system hostname by editing <code>/etc/hostname</code></p></li>
</ol></li>
<li><p>Reboot the system using <code>reboot</code> command. This should allow DHCP and NTP to do their thing and allow us to update the system and install new packages.</p></li>
<li><p>Log in as the new user you created</p></li>
<li><p>Update the system by running the following command until there is no output.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> xbps-install -Svu</code></pre></div></li>
<li><p>Install the following packages.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> xbps-install nano network-ups-tools rng-tools thefuck vim htop</code></pre></div></li>
<li><p>Install terminfo package to fix issues with ssh</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> xbps-install st-terminfo</code></pre></div></li>
<li><p>Setup syslog daemon</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> xbps-install socklog-void
<span class="kw">sudo</span> ln -s /etc/sv/socklog-unix /var/service
<span class="kw">sudo</span> ln -s /etc/sv/nanoklogd /var/service
<span class="co"># so normal user can access logs</span>
<span class="kw">sudo</span> usermod -a -G socklog <span class="ot">$USER</span></code></pre></div></li>
</ol>
<h3 id="nut-config">
NUT Configuration
</h3>
<p>Config files for Network UPS Tool (NUT) are found at <code>/etc/ups/</code></p>
<p><code>nut.conf</code> has a few global config options, which are not important on void.</p>
<p><code>ups.conf</code> is where you configure what UPSes the system will be interacting with</p>
<p><code>upsd.conf</code> is the configuration for the UPS data server</p>
<p>Configuration steps as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Edit <code>/etc/ups/nut.conf</code> and set <code>MODE=netserver</code>. This is not strictly required on void, but still better to set.</p></li>
<li><p>Run <code>nut-scanner</code> to generate config options for attached UPSes</p></li>
<li><p>Edit <code>/etc/ups/ups.conf</code> and add the results of <code>nut-scanner</code> to the begining of the file, except the vendor line. Add <code>[cyberpower]</code> before. See syntax examples in config file.</p></li>
<li><p>Edit <code>/etc/ups/upsd.conf</code> and update listen directive to the IP address of the local system.</p></li>
<li><p>Edit <code>/etc/ups/upsd.users</code> and add an <code>admin</code> user, and <code>upsmon</code> users with passwords from password safe. One <code>upsmon</code> user per machine connected to UPS.</p>
<ul>
<li>admin user has set actions and all instcmds</li>
<li>upsmon user is set up per example in config file with slave attributes</li>
</ul></li>
</ol>
<p>Need to change ownership of config files on void linux as the default is set up incorrectly:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> chown root:nut /etc/ups/*
<span class="kw">sudo</span> chmod 640 /etc/ups/*</code></pre></div>
<p>start the following services:</p>
<p><code>bash sudo ln -s /etc/sv/upsdrvctl/ /var/service sudo ln -s /etc/sv/upsd/ /var/service</code></p>
<p>check status of ups with the following command to make sure it is detected properly</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">upsc</span> cyberpower</code></pre></div>
<pre class="tags"><code>build-script, rack-monitor, notes</code></pre>
</body>
</html>
