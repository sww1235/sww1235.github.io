<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="author" content="Stephen Walker-Weinshenker">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="styles/main.css">
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
<title>build-script-notes-void-vm</title>
</head>
<body>
<div id="top">
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</div>
<div id="topnavbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</div>
<h1 id="top">
Main Workstation Build Script and Notes
</h1>
<p>This is the build script for my main void linux virtual machine that I use as my main workstation.</p>
<h2 id="notes">
Notes
</h2>
<h2 id="build-script">
Build Script
</h2>
<h3 id="initial-configuration">
Initial Configuration
</h3>
<ol style="list-style-type: decimal">
<li><p>Download the void-live-x86_64.iso of void linux from reputable sources, currently <a href="https://alpha.de.repo.voidlinux.org/live/current/">here</a></p></li>
<li><p>Mount iso vm using <code>vm-manager.sh</code></p></li>
<li><p>Login as root with default password of <code>void-linux</code> to live image.</p></li>
<li><p>Make sure you are booted using UEFI by validating presence of <code>/sys/firmware/efi</code> directory</p></li>
<li><p>run <code>void-installer</code></p></li>
<li><p>Proceed through installation wizard</p>
<ol style="list-style-type: decimal">
<li><p>Keyboard=us</p></li>
<li><p>Select DHCP</p></li>
<li><p>Source=network</p></li>
<li><p>Hostname=void-vm</p></li>
<li><p>System Locale=en_US.UTF-8</p></li>
<li><p>Timezone=America/Denver or appropriate</p></li>
<li><p>Root password from password manager - generated</p></li>
<li><p>User account from password manager</p></li>
<li><p>Select sda1, and no for graphical terminal.</p></li>
<li><p>Partition main SSD using GPT scheme</p>
<ol style="list-style-type: decimal">
<li><p>Create a 500MiB partition of type <code>EFI system</code></p></li>
<li><p>Create a second partition with the remaining space of type <code>linux-filesystem</code></p></li>
<li><p>Select write to write partitions to disk</p></li>
</ol></li>
<li><p>Set filesystem</p>
<ol style="list-style-type: decimal">
<li><p>Set 500MiB partition <code>vfat</code> filesystem and mount it at <code>/boot/efi</code></p></li>
<li><p>Set second partition to <code>ext4</code> and mount it at <code>/</code></p></li>
</ol></li>
<li><p>Review settings</p></li>
<li><p>Install</p></li>
<li><p>Wait</p></li>
<li><p>Exit installer</p></li>
<li><p>Shutdown system with <code>shutdown -h now</code></p></li>
<li><p>Comment out cdrom directives in vm-manager script</p></li>
<li><p>Start up VM again</p></li>
</ol></li>
<li><p>Log in as the new user you created.</p></li>
<li><p>Update the system by running the following command until there is no output.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> xbps-install -Svu</code></pre></div></li>
<li><p>Install the following packages. The st-terminfo install fixes <code>st-256color unknown terminal type</code> issues as well as backspace and tab issues when sshing in from other computers using the <code>st</code> terminal emulator.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> xbps-install nano thefuck vim st-terminfo git</code></pre></div></li>
<li><p>Setup system logging using socklog</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> xbps-install socklog-void
<span class="co"># enable services</span>
<span class="fu">sudo</span> ln -s /etc/sv/socklog-unix/ /var/service
<span class="fu">sudo</span> ln -s /etc/sv/nanoklogd/ /var/service
<span class="co"># add user to log group</span>
<span class="fu">sudo</span> usermod -a -G socklog <span class="va">$USER</span>
<span class="co"># log out and log back in</span></code></pre></div></li>
<li><p>Start ssh service <code>sudo ln -s /etc/sv/sshd/ /var/service</code> so you can log in remotely.</p></li>
<li><p>Generate ssh-keys <code>ssh-keygen -t ed25519</code> and enter passphrase from password manager</p></li>
<li><p>Add public key to github.</p></li>
<li><p>Set up git.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">git</span> config --global user.email <span class="st">&quot;sww1235@gmail.com&quot;</span>
<span class="fu">git</span> config --global user.namer <span class="st">&quot;Stephen Walker-Weinshenker&quot;</span></code></pre></div></li>
<li><p>Set up ssh-agent using user specific services. Instructions taken from <a href="https://www.daveeddy.com/2018/09/15/using-void-linux-as-my-daily-driver/" class="uri">https://www.daveeddy.com/2018/09/15/using-void-linux-as-my-daily-driver/</a></p>
<ol style="list-style-type: decimal">
<li>Create user specific service directory:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> mkdir /etc/sv/runit-user-toxicsauce</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Create run script for user specific service by adding the following into <code>/etc/sv/runit-user-toxicsauce/run</code></li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/sh</span>
<span class="bu">exec</span> <span class="op">2&gt;&amp;1</span>
<span class="bu">exec</span> chpst -u toxicsauce:toxicsauce runsvdir /home/toxicsauce/runit/service</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Mark it as executable:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> chmod +x /etc/sv/runit-user-toxicsauce/run</code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Create necessary user specific service directories:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> ~/runit
<span class="fu">mkdir</span> ~/runit/sv
<span class="fu">mkdir</span> ~/runit/service</code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Start this service of services with:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> ln -s /etc/sv/runit-user-toxicsauce /var/service</code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Now set up <code>ssh-agent</code> service:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> ~/runit/sv/ssh-agent</code></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>Create run script for <code>ssh-agent</code> service by adding the following into <code>~/runit/sv/ssh-agent/run</code>.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/usr/bin/env bash</span>
<span class="co">#</span>
<span class="co"># Start ssh-agent from runit</span>

<span class="va">file=</span>~/.ssh/ssh-agent-env

<span class="bu">exec</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">$file</span><span class="st">&quot;</span>

<span class="bu">echo</span> <span class="st">&quot;# started </span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st">&quot;</span>

<span class="co"># For some reason, this line doesn&#39;t get emitted by ssh-agent when it is run</span>
<span class="co"># with -d or -D.  Since we are starting the program with exec we already know</span>
<span class="co"># the pid ahead of time though so we can create this line manually</span>
<span class="bu">echo</span> <span class="st">&quot;SSH_AGENT_PID=</span><span class="va">$$</span><span class="st">; export SSH_AGENT_PID&quot;</span>

<span class="bu">exec</span> ssh-agent -D</code></pre></div>
<ol start="8" style="list-style-type: decimal">
<li>Mark run file as executable with:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">chmod</span> +x ~/runit/sv/ssh-agent/run</code></pre></div>
<ol start="9" style="list-style-type: decimal">
<li>Now start the service with:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ln</span> -s ~/runit/sv/ssh-agent ~/runit/service</code></pre></div>
<p><strong>NOTE</strong>: you need the following line in bashrc in order to get it working in new shells. This is already in my dotfiles bashrc</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># source ssh-agent file</span>

<span class="bu">[</span> <span class="ot">-f</span> <span class="va">$HOME</span>/.ssh/ssh-agent-env<span class="bu"> ]</span> <span class="kw">&amp;&amp;</span> <span class="bu">source</span> <span class="va">$HOME</span>/.ssh/ssh-agent-env</code></pre></div></li>
<li><p>Create Projects directory tree in <code>~</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> -p ~/projects/src/github.com/sww1235</code></pre></div>
<p>This mirrors the structure of how golang wants to set things up.</p></li>
<li><p>Make symlink in <code>~</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ln</span> -s ~/projects/src/github.com/sww1235 myprojects</code></pre></div></li>
<li><p>Clone dotfiles repo from GitHub using ssh and install vim and bash files using <code>install.sh</code> script.</p></li>
<li><p>Clone projects from github into Projects tree as desired.</p></li>
<li><p>Set up void-packages per the <a href="void-packages-setup.html">instructions</a> in this wiki.</p></li>
<li><p>Make sure <code>build-branch-void-vm</code> in my fork of <code>void-packages</code> is checked out, and up to date with desired patches. See the <a href="void-suckless-config.html">suckless page</a> for more info.</p></li>
<li><p>Build binary packages of <code>dwm</code>, <code>dmenu</code>, and <code>st</code> as follows:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> ~/Projects/src/github.com/sww1235/void-packages
<span class="ex">./xbps-src</span> pkg dwm
<span class="ex">./xbps-src</span> pkg dmenu
<span class="ex">./xbps-src</span> pkg st</code></pre></div></li>
<li><p>Install <code>dwm</code>, <code>dmenu</code>, and <code>st</code> with the command:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> xbps-install --repository=hostdir/binpkgs/build-branch-void-vm dwm dmenu st</code></pre></div></li>
<li><p>Install <code>xorg</code> and <code>xorg-fonts</code> to get graphics working</p></li>
<li><p>Install and run <code>arandr</code> to generate a <code>xrandr</code> command to fix the monitor rotation. Save the script as <code>~/.screenlayout/main.sh</code></p></li>
<li><p>Install <code>xscreensaver</code>, then run <code>xscreensaver-demo</code> and unselect the screensavers that you don't want to run.</p></li>
<li><p>Modify ~/.xinitrc to contain the following:</p>
<pre class="xinitrc"><code>~/.screenlayout/main.sh
xscreensaver &amp;
exec dwm</code></pre></li>
</ol>
<h2 id="resources">
Resources
</h2>
<pre class="tags"><code>build-script, main-ws-host, workstation, notes, QEMU, KVM, VFIO, Passthrough</code></pre>
</body>
</html>
