<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="author" content="Stephen Walker-Weinshenker">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="styles/main.css">
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
<title>void-vfio-config</title>
</head>
<body>
<div id="top">
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</div>
<div id="topnavbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</div>
<p>install DBUS from xbps</p>
<p>Add iommu=pt and either:</p>
<pre><code> For Intel CPUs (VT-d) set intel_iommu=on
For AMD CPUs (AMD-Vi) set amd_iommu=on</code></pre>
<p>to GRUB_CMDLINE_LINUX_DEFAULT line in /etc/default/grub</p>
<p>confirm that iommu is on:</p>
<p><code>dmesg | grep -e DMAR -e IOMMU</code></p>
<h2 id="iommu-group-check">iommu group check</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="bu">shopt</span> -s nullglob</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">for</span> <span class="ex">d</span> in /sys/kernel/iommu_groups/*/devices/*<span class="kw">;</span> <span class="kw">do</span> </a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="va">n=${d#</span>*/iommu_groups/*<span class="va">}</span>; <span class="va">n=${n%%</span>/*<span class="va">}</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="bu">printf</span> <span class="st">&#39;IOMMU Group %s &#39;</span> <span class="st">&quot;</span><span class="va">$n</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="ex">lspci</span> -nns <span class="st">&quot;</span><span class="va">${d##</span>*/<span class="va">}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">done</span>;</a></code></pre></div>
<p>make sure only to add pci ids of graphics card and associated audio device, not the root if in the same group.</p>
<h2 id="configure-vfio-pci">configure vfio-pci</h2>
<p>change IDs to match those found through lspci for your specific card</p>
<pre><code>/etc/modprobe.d/vfio.conf

options vfio-pci ids=10de:13c2,10de:0fbb</code></pre>
<p>to load kernel modules:</p>
<p>make file in /etc/modules-load.d/ (may need to make directory first)</p>
<p>file can be called anything with a .conf after it. modules are listed one per line. I loaded</p>
<p>-vfio -vfio-pci -vfio-virqfd</p>
<p>dracut is used to make initramfs</p>
<p>its config is /etc/dracut.conf.d/dracut.conf</p>
<p>need to add kernel modules to initramfs</p>
<p>use add_drivers+=“vfio-pci vfio vfio_iommu_type1 vfio_virqfd” as an example</p>
<p>also need to add_dracutmodules+=“kernel-modules” in order for dracut to look at modprobe/modules-load</p>
<p>I also needed to blacklist nouvaeu on the host using a config file in /etc/modprobe.d/ containing <code>blacklist nouveau</code> and in dracut.conf using `omit_drivers+=“nouveau”</p>
<p>regen initramfs using dracut –force to overwrite the existing one</p>
<h2 id="getting-ovmf">getting ovmf</h2>
<p>it is not in xbps so need to manually download from https://www.kraxel.org/repos/jenkins/edk2/ as of the writing of this build. download the ovmf appropriate either 32 or 64 bit version then use</p>
<p>rpm2cpio <file>.rpm | xz -d | cpio -idmv</p>
<p>otherwise you could try:</p>
<p>rpm2cpio <file>.rpm | lzma -d | cpio -idmv</p>
<p>to extract the files needed.</p>
<p>install rpmextract package xbps</p>
<p>copy files in ./usr/share/edk2.git/ovmf-x64 to /usr/share/ovmf</p>
<p>and then set the config option in /etc/libvirt/qemu.conf</p>
<p><code>nvram</code> to the appropriate files. smm varients include secure boot code, csm varients include legacy compat modules. code and vars are separate files taht are both contained in OVMF base.</p>
<p>need to add user to kvm and libvirt groups</p>
</body>
</html>
