<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <meta name="author" content="Stephen Walker-Weinshenker">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="styles/main.css">
  <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
<title>build-script-notes-virt-cluster</title>
</head>
<body>
<div id="top">
    <a href="index.html">
        <img src="images/logo.png" alt="Home" width="280" height="32">
    </a>

</div>
<div id="topnavbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="stuff.html">Stuff</a>
            <ul>
                <li><a href="https://github.com/sww1235">Github</a></li>
                <li><a href="wiki/index.html">Wiki</a></li>

            </ul>
        </li>
        <li><a href="blog-contents">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>

    </ul>
</div>
<h1 id="top">
Virtualization Cluster Configuration
</h1>
<p>Documentation on setup of virtualization cluster. Some info may be split into its own page.</p>
<p>Current status of cluster, is 3 Intel NUCs, each running Xen as a tier 1 hypervisor with FreeBSD as Dom0.</p>
<h2 id="ind-host-setup">
Individual Host Setup
</h2>
<h3 id="bios-config">
BIOS Configuration
</h3>
<ol type="1">
<li><p>Boot system into BIOS by spamming <code>F2</code> key after pressing power button.</p></li>
<li><p>Check that all RAM and CPU are properly detected on <code>Main</code> tab.</p></li>
<li><p>Under <code>Advanced-&gt;Storage</code>: Disable SATA port since we are not using it.</p></li>
<li><p>Under <code>Advanced-&gt;Onboard Devices</code>: Disable HD Audio, WLAN, Bluetooth, Gaussian Mixture Models, HDMI CEC Control, and Enable IOMMU during pre-boot</p></li>
<li><p>Under <code>Advanced-&gt;Video</code>: Set IGD Primary Video Port to HDMI and enable <code>Virtual Display Emulation</code> under <code>Display Emulation</code></p></li>
<li><p>Under <code>Security</code>: Enable USB Provisioning of Intel AMT.</p></li>
<li><p>Under <code>Power-&gt;Secondary Power Settings</code>: Change After Power Failure to Power On.</p></li>
<li><p>Under <code>Boot-&gt;Secure Boot</code>: Disable Secure Boot</p></li>
<li><p>Under <code>Boot-&gt;Boot Priority</code>: Enable Boot USB Devices First, and disable Boot Network Devices Last.</p></li>
<li><p>Under <code>Boot-&gt;Boot Display Configuration</code>: Disable Suppress Alert Messages At Boot, and Enable F12 for network boot.</p></li>
<li><p>Under <code>Main</code> Select System Time and Set BIOS clock to UTC time.</p></li>
<li><p>Press F10 to save and Exit. On Reboot, press <code>CTRL-P</code> to get into Intel AMT configuration</p></li>
</ol>
<h3 id="amt-config">
AMT Configuration
</h3>
<ol type="1">
<li><p>Press <code>CTRL-P</code> at boot prompt to enter Intel AMT configuration.</p></li>
<li><p>Hit <code>Enter</code> to login to AMT, with default password of <code>admin</code>. When prompted to enter new password, use password out of password manager.</p></li>
<li><p>Under <code>Intel AMT Configuration-&gt;User Consent</code>: Change User Opt-in to NONE.</p></li>
<li><p>Under <code>Intel AMT Configuration-&gt;Network Setup-&gt;Intel ME Network Name Settings</code>: Set hostname and domain to desired values. Leave Shared/Dedicated FQDN set to shared.</p></li>
<li><p>Set static DHCP lease in DHCP server if not done already.</p></li>
</ol>
<h3 id="os-install">
Install Operating System
</h3>
<ol type="1">
<li><p>Download FreeBSD-bootonly ISO from reputable sources. Use this to reduce loading times</p></li>
<li><p>Connect to system using Mesh Commander.</p></li>
<li><p>Mount ISO using IDE-R, and select <code>Reset to IDE-R</code> in <code>Power Actions</code> menu.</p></li>
<li><p>Let FreeBSD boot to the install menu. Don’t exit out of the autoboot menu.</p></li>
<li><p>Press enter to start the installation process.</p></li>
<li><p>Proceed through installation wizard. Press space to select options.</p>
<ol type="1">
<li><p>Keymap = United States of America. Space will not work here, just scroll down and hit enter.</p></li>
<li><p>Enter hostname</p></li>
<li><p>Add the ports tree.</p></li>
<li><p>Hit Ok to configure network for installation.</p></li>
<li><p>Configure IPv4 and use DHCP</p></li>
<li><p>Confirm resolver config. (Defaults picked up from DHCP should be good to go.)</p></li>
<li><p>Select default (main) FreeBSD mirror.</p></li>
<li><p>Select Auto (UFS) and then Entire Disk.</p></li>
<li><p>Select GPT for partition scheme</p></li>
<li><p>Review autogen partition layout, which should be good for our usages then hit finish and Commit.</p></li>
<li><p>Wait for download, verification and extraction.</p></li>
<li><p>Enter root password from password manager.</p></li>
<li><p>Choose yes at CMOS clock prompt. Make sure this gets set in BIOS properly.</p></li>
<li><p>Choose timezone.</p></li>
<li><p>Skip time and date setup if it is correct.</p></li>
<li><p>Enable <code>local_unbound</code>, <code>sshd</code>, <code>ntpdate</code>, <code>ntpd</code>, <code>powerd</code> and <code>dumpdev</code> services to be started at boot</p></li>
<li><p>Enable all security options except <code>disable_syslogd</code>, and <code>secure_console</code>.</p></li>
<li><p>Add new admin user.</p>
<ol type="1">
<li>Username = <code>toxicsauce</code></li>
<li>Full Name = <code>toxicsauce</code></li>
<li>UID = (hit enter to accept default)</li>
<li>Login group = (hit enter to accept default)</li>
<li>Invite User to other groups = wheel</li>
<li>Login class = (hit enter to accept default)</li>
<li>Shell = sh (default)</li>
<li>home directory = (hit enter to accept default)</li>
<li>home directory permissions = (hit enter to accept defaults)</li>
<li>password auth = yes</li>
<li>empty password = no</li>
<li>random password = no</li>
<li>Enter password from password manager</li>
<li>lock account = no</li>
<li>check options and type in yes to confirm.</li>
<li>add additional users = no.</li>
</ol></li>
<li><p>hit exit, and no to exit installer.</p></li>
<li><p>Hit reboot.</p></li>
<li><p>Stop CD media after system has rebooted.</p></li>
</ol></li>
<li><p>Login as the new user you created</p></li>
<li><p>Become root with <code>su -</code>. You will need root’s password.</p></li>
<li><p>Update system and install software</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">freebsd-update</span> fetch</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ex">freebsd-update</span> install</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="ex">pkg</span> update</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co"># answer yes to install pkg system</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="ex">pkg</span> upgrade</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="ex">pkg</span> install nano sudo vim-console</a></code></pre></div></li>
<li><p>Configure sudo. <code>visudo</code> and uncomment line <code>%wheel ALL=(ALL) ALL</code></p></li>
<li><p>Setup system logging and disable sendmail:</p>
<ol type="1">
<li><p>Edit <code>/etc/rc.conf</code> and add the following lines to disable sendmail and enable syslog.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb2-1" title="1"><span class="co"># disable sendmail and enable syslog</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="dt">syslogd_enable</span><span class="ot">=</span><span class="st">&quot;YES&quot;</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="dt">newsyslog_enable</span><span class="ot">=</span><span class="st">&quot;YES&quot; # make sure this doesn&#39;t break in future </span><span class="kw">defaults</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="dt">sendmail_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot; # modify existing line</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="dt">sendmail_submit_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="dt">sendmail_outbound_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="dt">sendmail_msp_queue_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co"># fix cron trying to send mail</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="dt">cron_flags</span><span class="ot">=</span><span class="st">&quot;-m &#39;&#39;&quot;</span></a></code></pre></div></li>
<li><p>Create log files needed for next step:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">sudo</span> touch /var/log/console.log</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="fu">sudo</span> chmod 600 /var/log/console.log</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="fu">sudo</span> touch /var/log/all.log</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="fu">sudo</span> chmod 600 /var/log/all.log</a></code></pre></div></li>
<li><p>Edit <code>/etc/syslog.conf</code> and uncomment the lines for <code>console.log</code> and <code>all.log</code>. TODO: setup remote logging.</p></li>
<li><p>Check <code>/etc/newsyslog.conf</code> to confirm log rotation is setup correctly.</p></li>
<li><p>Edit <code>/etc/periodic.conf</code> and add the following to the beginning of the file to disable sending root email and instead log to syslog. (This will override the defaults in <code>/etc/defaults/periodic.conf</code>)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># redirect periodic output to syslog files</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="dt">daily_output</span><span class="ot">=</span><span class="st">&quot;/var/log/daily.log&quot; # user or /file</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="dt">weekly_output</span><span class="ot">=</span><span class="st">&quot;/var/log/weekly.log&quot; # user or /file</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="dt">monthly_output</span><span class="ot">=</span><span class="st">&quot;/var/log/monthly.log&quot; # user or /file</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co"># turn off sendmail periodic functions</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="dt">daily_clean_hoststat_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="dt">daily_status_mail_rejects_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="dt">daily_status_include_submit_mailq</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="dt">daily_submit_queuerun</span><span class="ot">=</span><span class="st">&quot;NO&quot;</span></a></code></pre></div></li>
<li><p>Fix crontab logging by editing <code>/etc/crontab</code> and appending <code>2&gt;&amp;1 | /usr/bin/logger -t cron_xxx</code> and replacing xxx with whatever the cron command was doing. Do not need to do this for periodic and periodic snapshot sections.</p></li>
</ol></li>
<li><p>Random sysadmin tweaks:</p>
<ol type="1">
<li><p>Edit <code>/etc/periodic.conf</code> and include the following lines:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># never going to use locate on a virtualization host</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="dt">weekly_locate_enable</span><span class="ot">=</span><span class="st">&quot;NO&quot;   #Disable weekly locate run.</span></a></code></pre></div></li>
</ol></li>
<li><p>Reboot</p></li>
</ol>
<h2 id="cluster-setup">
Cluster Setup
</h2>
<ol type="1">
<li><p>Before UEFI support for XEN is merged in a freebsd release version, need to fetch and compile from source. Wait until commit <code>97527e9c4fd37140</code> is merged into master before removing these instructions and running on release version.</p></li>
<li><p>Run the following commands as root to build and install FreeBSD from source</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">git</span> clone --branch releng/10.3 https://git.FreeBSD.org/src.git /usr/src</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="bu">cd</span> /usr/src/</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="fu">make</span> buildworld <span class="kw">&amp;&amp;</span> <span class="fu">make</span> buildkernel</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="fu">make</span> installkernel</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="ex">shutdown</span> -r now</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="bu">cd</span> /usr/src/</a>
<a class="sourceLine" id="cb6-7" title="7"><span class="fu">make</span> installworld</a>
<a class="sourceLine" id="cb6-8" title="8"><span class="ex">shutdown</span> -r now</a></code></pre></div></li>
<li><p>Once the reboots have completed, need to merge config files, and check for outdated libraries. Run as root.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="ex">etcupdate</span> diff <span class="co"># to see what changed in settings</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="ex">etcupdate</span> <span class="co"># to automagically merge changes</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="ex">etcupdate</span> resolve <span class="co"># if needed to resolve any changes that couldn&#39;t be merged automatically</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="bu">cd</span> /usr/src/</a>
<a class="sourceLine" id="cb7-5" title="5"><span class="fu">make</span> check-old <span class="co"># obsolete files or directories</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="fu">make</span> delete-old</a>
<a class="sourceLine" id="cb7-7" title="7"><span class="fu">make</span> check-old-libs <span class="co"># obsolete libraries</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="fu">make</span> delete-old-libs</a>
<a class="sourceLine" id="cb7-9" title="9"><span class="ex">shutdown</span> -r now</a></code></pre></div></li>
<li><p>Finally start installing Xen. All commands run as root.</p>
<ol type="1">
<li><p>sudo pkg install xen-kernel xen-tools. May have to regenerate pkg database</p></li>
<li><p>add the line <code>vm.max_user_wired=-1</code> to <code>/etc/sysctl.conf</code></p></li>
<li><p>add the line <code>xc0     "/usr/libexec/getty Pc"         xterm   onifconsole  secure</code> to <code>/etc/ttys</code></p></li>
<li><p>edit <code>/boot/loader.conf</code> and add the following lines for 2G memory and 1vCPU core dom0:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb8-1" title="1"><span class="dt">if_tap_load</span><span class="ot">=</span><span class="st">&quot;YES&quot;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="dt">xen_kernel</span><span class="ot">=</span><span class="st">&quot;/boot/xen&quot;</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="dt">xen_cmdline</span><span class="ot">=</span><span class="st">&quot;dom0_mem=2048M dom0_max_vcpus=</span><span class="dv">1</span><span class="st"> dom0=pvh com1=</span><span class="dv">115200</span><span class="st">,8n1 guest_loglvl=all loglvl=all console=vga,com1&quot;</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="dt">boot_multicons</span><span class="ot">=</span><span class="st">&quot;YES&quot;</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="dt">boot_serial</span><span class="ot">=</span><span class="st">&quot;YES&quot;</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="dt">console</span><span class="ot">=</span><span class="st">&quot;commconsole,vidconsole&quot;</span></a></code></pre></div></li>
<li><p>run the following commands:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="ex">sysrc</span> xencommons_enable=yes</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="ex">sysrc</span> cloned_interfaces=<span class="st">&quot;bridge0&quot;</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="ex">sysrc</span> ifconfig_bridge0=<span class="st">&quot;addm em0 SYNCDHCP&quot;</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="ex">sysrc</span> ifconfig_em0=<span class="st">&quot;up&quot;</span></a></code></pre></div></li>
<li><p>Reboot system</p></li>
</ol></li>
</ol>
<pre class="tags"><code>cluster, virtualization, virt, NUC, xcp-ng</code></pre>
</body>
</html>
